<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦† DUCK-WOD</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ===== THEME: Duck Logo Colors =====
           Primary:   #E8451A (orange-red)
           Secondary: #1A9B8A (teal)
           Accent:    #F5C518 (yellow)
           BG:        #1a1a1a (dark)
           Card:      #222222
        */
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #111111;
            color: #f0ece0;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(160deg, #1a1a1a 0%, #2a1a0a 60%, #1a1a1a 100%);
            padding: 20px 20px 16px;
            text-align: center;
            border-bottom: 3px solid #E8451A;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -40px; left: -40px;
            width: 180px; height: 180px;
            background: radial-gradient(circle, rgba(232,69,26,0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 180px; height: 180px;
            background: radial-gradient(circle, rgba(26,155,138,0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .logo {
            font-size: 3.2em;
            margin-bottom: 6px;
            filter: drop-shadow(0 2px 6px rgba(232,69,26,0.5));
        }

        h1 {
            font-size: 2.6em;
            font-weight: 900;
            letter-spacing: 3px;
            margin-bottom: 4px;
            /* Matches logo: "THE DUCK'S" in orange-red, "FITNESS" in teal */
            background: linear-gradient(90deg, #E8451A 0%, #F5C518 50%, #1A9B8A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #aaa;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        /* Day Navigation */
        .day-nav {
            display: flex;
            gap: 8px;
            padding: 14px 16px;
            overflow-x: auto;
            background: #181818;
            border-bottom: 1px solid #2a2a2a;
        }

        .day-btn {
            min-width: 76px;
            padding: 10px 14px;
            background: #1e1e1e;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            color: #f0ece0;
        }

        .day-btn:hover {
            border-color: #E8451A;
            transform: translateY(-2px);
        }

        .day-btn.active {
            background: #E8451A;
            border-color: #E8451A;
            color: #fff;
        }

        .day-name {
            font-weight: 700;
            font-size: 0.9em;
        }

        .day-date {
            font-size: 0.75em;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            background: #181818;
            border-bottom: 1px solid #2a2a2a;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #1e1e1e;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #f0ece0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: #E8451A;
        }

        .tab-btn.active {
            background: #E8451A;
            border-color: #E8451A;
            color: #fff;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Workout Cards */
        .workouts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .workout-card {
            background: #1e1e1e;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .workout-card:hover {
            border-color: #E8451A;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(232,69,26,0.15);
        }

        .card-header {
            border-bottom: 2px solid #E8451A;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }

        .source-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #F5C518;
        }

        .source-note {
            font-size: 0.85em;
            color: #ff9800;
            margin-top: 5px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 700;
            text-decoration: underline;
            color: #1A9B8A;
            margin-bottom: 10px;
        }

        .section-lines {
            list-style: none;
            padding-left: 0;
        }

        .section-lines li {
            padding: 4px 0 4px 20px;
            position: relative;
            color: #f0ece0;
        }

        .section-lines li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #E8451A;
            font-weight: bold;
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a2a2a;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #E8451A;
            color: #fff;
        }

        .btn-primary:hover {
            background: #c73a15;
        }

        .btn-secondary {
            background: #25d366;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #20c05a;
        }

        /* Find Workout */
        .find-form {
            max-width: 600px;
            margin: 0 auto;
            background: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #F5C518;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            border-radius: 6px;
            color: #f0ece0;
            font-size: 1em;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .equipment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #111;
            border-radius: 6px;
            cursor: pointer;
            color: #f0ece0;
        }

        .equipment-item:hover {
            background: #2a2a2a;
        }

        .equipment-item input {
            width: auto;
            cursor: pointer;
            accent-color: #E8451A;
        }

        .match-score {
            display: inline-block;
            background: #E8451A;
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            margin-left: 10px;
        }

        /* Source Toggle */
        .sources-list {
            max-width: 600px;
            margin: 0 auto;
        }

        .source-item {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #f0ece0;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #444;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #1A9B8A;
        }

        .toggle-switch .slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .slider {
            transform: translateX(30px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .workouts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ðŸ¦†</div>
        <h1>DUCK-WOD</h1>
        <p style="color:#888; font-size:0.85em; letter-spacing:2px;">DAILY CROSSFIT WORKOUTS</p>
    </div>

    <div class="day-nav" id="dayNav"></div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('browse')">Browse</button>
        <button class="tab-btn" onclick="switchTab('find')">Find Workout</button>
        <button class="tab-btn" onclick="switchTab('sources')">Sources</button>
    </div>

    <!-- BROWSE TAB -->
    <div id="browse-tab" class="tab-content active">
        <div class="workouts-grid" id="workoutsGrid">
            <div class="loading">Loading workouts...</div>
        </div>
    </div>

    <!-- FIND WORKOUT TAB -->
    <div id="find-tab" class="tab-content">
        <div class="find-form">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">Find Your Workout</h2>
            
            <div class="form-group">
                <label>Available Time (minutes)</label>
                <input type="number" id="findTime" min="1" max="180" value="20">
            </div>

            <div class="form-group">
                <label>Available Equipment</label>
                <div class="equipment-grid">
                    <label class="equipment-item">
                        <input type="checkbox" value="RUN"> RUN
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="BARBELL"> BARBELL
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="PULL-UP"> PULL-UP
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="ROW"> ROW
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="BIKE"> BIKE
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="DUMBBELL"> DUMBBELL
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="KETTLEBELL"> KETTLEBELL
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="ROPE CLIMB"> ROPE CLIMB
                    </label>
                    <label class="equipment-item">
                        <input type="checkbox" value="DOUBLE UNDERS"> DOUBLE UNDERS
                    </label>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="findWorkout()">
                Find Best Match
            </button>
        </div>

        <div class="workouts-grid" id="findResults" style="margin-top: 30px;"></div>
    </div>

    <!-- SOURCES TAB -->
    <div id="sources-tab" class="tab-content">
        <div class="sources-list" id="sourcesList">
            <div class="loading">Loading sources...</div>
        </div>
    </div>

    <script>
        let allData = null;
        let currentDate = new Date();
        
        // Fixed 5 sources (hardcoded, not editable)
        const SOURCES = {
            'myleo': { name: 'myleo CrossFit', enabled: true, has_archive: true },
            'greenbeach': { name: 'CrossFit Green Beach', enabled: true, has_archive: false },
            'linchpin': { name: 'CrossFit Linchpin', enabled: true, has_archive: false },
            'postal': { name: 'CrossFit Postal', enabled: true, has_archive: false },
            'crossfit_com': { name: 'CrossFit.com', enabled: true, has_archive: true }
        };

        // Load saved toggles from localStorage
        const savedToggles = localStorage.getItem('duck-wod-toggles');
        if (savedToggles) {
            try {
                const toggles = JSON.parse(savedToggles);
                Object.keys(toggles).forEach(id => {
                    if (SOURCES[id]) SOURCES[id].enabled = toggles[id];
                });
            } catch (e) {
                console.error('Error loading toggles:', e);
            }
        }

        // Equipment keywords for matching (expanded)
        const EQUIPMENT_KEYWORDS = {
            'RUN': ['run', 'running', 'meter', 'mile', 'km'],
            'BARBELL': ['barbell', 'clean', 'snatch', 'deadlift', 'squat', 'press', 'jerk'],
            'PULL-UP': ['pull-up', 'pullup', 'pull up', 'chest-to-bar', 'c2b'],
            'ROW': ['row', 'rowing', 'rower', 'cal row'],
            'BIKE': ['bike', 'assault bike', 'echo bike', 'cal bike'],
            'DUMBBELL': ['dumbbell', 'db'],
            'KETTLEBELL': ['kettlebell', 'kb'],
            'ROPE CLIMB': ['rope climb', 'rope climbs'],
            'DOUBLE UNDERS': ['double under', 'double unders', 'du']
        };

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initDayNav();
            displayWorkouts();
            displaySources();
        });

        async function loadData() {
            try {
                // FIXED: Correct path for GitHub Pages root
                const response = await fetch("./data/workouts.json");
                allData = await response.json();
                console.log('Data loaded:', allData);
            } catch (error) {
                console.error('Error loading data:', error);
                allData = { workouts: {} };
            }
        }

        function initDayNav() {
            const nav = document.getElementById('dayNav');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let html = '';
            for (let i = 0; i < 14; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                const dayName = i === 0 ? 'TODAY' : days[date.getDay()];
                const dateStr = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                html += `
                    <button class="day-btn ${i === 0 ? 'active' : ''}" onclick="selectDay(${i})">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${dateStr}</div>
                    </button>
                `;
            }
            
            nav.innerHTML = html;
        }

        function selectDay(daysAgo) {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            currentDate = date;
            
            document.querySelectorAll('.day-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === daysAgo);
            });
            
            displayWorkouts();
        }

        // Returns YYYY-MM-DD in LOCAL time (fixes Israel UTC+2 bug)
        function toLocalDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function displayWorkouts() {
            const grid = document.getElementById('workoutsGrid');
            const dateStr = toLocalDateStr(currentDate);
            
            console.log('Displaying workouts for:', dateStr);
            const workouts = allData.workouts[dateStr] || [];
            console.log('Found workouts:', workouts);
            
            // Filter by enabled sources
            const enabled = workouts.filter(w => SOURCES[w.source]?.enabled);
            
            if (enabled.length === 0) {
                grid.innerHTML = '<div class="loading">No workouts for this day</div>';
                return;
            }
            
            grid.innerHTML = enabled.map(w => renderCard(w)).join('');
        }

        function renderCard(workout, matchScore = null) {
            return `
                <div class="workout-card">
                    <div class="card-header">
                        <div class="source-name">
                            ${workout.source_name || workout.source}
                            ${matchScore ? `<span class="match-score">${matchScore}%</span>` : ''}
                        </div>
                        ${workout.note ? `<div class="source-note">${workout.note}</div>` : ''}
                    </div>
                    ${workout.sections ? workout.sections.map(s => `
                        <div class="section">
                            <div class="section-title">${s.title}</div>
                            <ul class="section-lines">
                                ${s.lines.map(l => `<li>${escapeHtml(l)}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('') : '<div class="loading">No workout data</div>'}
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="shareWhatsApp(${JSON.stringify(workout.source_name || workout.source).replace(/"/g, '&quot;')}, ${JSON.stringify(workout.sections || []).replace(/"/g, '&quot;')})">
                            Share WhatsApp
                        </button>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function shareWhatsApp(sourceName, sectionsStr) {
            const sections = typeof sectionsStr === 'string' ? JSON.parse(sectionsStr.replace(/&quot;/g, '"')) : sectionsStr;
            let text = `ðŸ¦† DUCK-WOD\n${sourceName}\n\n`;
            
            if (sections && sections.length > 0) {
                sections.forEach(s => {
                    text += `${s.title}\n`;
                    if (s.lines) {
                        s.lines.forEach(l => text += `â€¢ ${l}\n`);
                    }
                    text += '\n';
                });
            }
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function findWorkout() {
            const time = parseInt(document.getElementById('findTime').value);
            const equipment = Array.from(document.querySelectorAll('.equipment-item input:checked'))
                .map(cb => cb.value);
            
            if (!time || equipment.length === 0) {
                alert('Please enter time and select at least one equipment');
                return;
            }
            
            const results = [];
            
            // Search all days
            Object.entries(allData.workouts).forEach(([date, dayWorkouts]) => {
                dayWorkouts.forEach(w => {
                    // Only enabled sources
                    if (!SOURCES[w.source]?.enabled) return;
                    
                    const score = calculateMatchScore(w, time, equipment);
                    if (score > 0) {
                        results.push({ workout: w, score: Math.round(score) });
                    }
                });
            });
            
            results.sort((a, b) => b.score - a.score);
            
            const container = document.getElementById('findResults');
            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No matching workouts found</div>';
                return;
            }
            
            const best = results[0];
            container.innerHTML = renderCard(best.workout, best.score);
        }

        function calculateMatchScore(workout, targetTime, equipment) {
            if (!workout.sections) return 0;
            
            const text = workout.sections
                .map(s => s.title + ' ' + (s.lines || []).join(' '))
                .join(' ')
                .toLowerCase();
            
            let score = 0;
            
            // Equipment match (60%)
            let equipmentMatches = 0;
            equipment.forEach(eq => {
                const keywords = EQUIPMENT_KEYWORDS[eq] || [];
                if (keywords.some(kw => text.includes(kw.toLowerCase()))) {
                    equipmentMatches++;
                }
            });
            score += (equipmentMatches / equipment.length) * 60;
            
            // Time estimate (40%)
            const timeMatch = text.match(/(\d+)\s*(min|minute)/i);
            if (timeMatch) {
                const wodTime = parseInt(timeMatch[1]);
                const diff = Math.abs(wodTime - targetTime);
                score += Math.max(0, 40 - diff * 2);
            } else {
                // Heuristic based on workout type
                if (/amrap/i.test(text) || /emom/i.test(text)) {
                    score += 20;
                } else {
                    score += 10;
                }
            }
            
            return score;
        }

        function displaySources() {
            const list = document.getElementById('sourcesList');
            
            list.innerHTML = Object.entries(SOURCES).map(([id, info]) => `
                <div class="source-item">
                    <div>
                        <strong>${info.name}</strong>
                        ${!info.has_archive ? '<div style="font-size:0.85em;color:#ff9800;">Daily only</div>' : ''}
                    </div>
                    <div class="toggle-switch ${info.enabled ? 'active' : ''}" 
                         onclick="toggleSource('${id}')">
                        <div class="slider"></div>
                    </div>
                </div>
            `).join('');
        }

        function toggleSource(id) {
            SOURCES[id].enabled = !SOURCES[id].enabled;
            
            // Save to localStorage
            const toggles = {};
            Object.keys(SOURCES).forEach(k => toggles[k] = SOURCES[k].enabled);
            localStorage.setItem('duck-wod-toggles', JSON.stringify(toggles));
            
            displaySources();
            displayWorkouts();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');
        }
    </script>
</body>
</html>
